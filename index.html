<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IES Örebro Teacher Availability Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #f0f4ff, #c3daff 50%, #e0eaff);
            --wave-pattern: repeating-linear-gradient(135deg, rgba(200, 225, 245, 0.1) 0, rgba(200, 225, 245, 0.1) 20px, rgba(180, 210, 235, 0.1) 20px, rgba(180, 210, 235, 0.1) 40px);
            --container-bg: rgba(255, 255, 255, 0.97);
            --section-bg: rgba(255, 255, 255, 0.99);
            --text-color: #1a202c;
            --accent-color: #34d399;
            --accent-dark: #059669;
            --border-color: rgba(52, 211, 153, 0.3);
            --button-bg: rgba(240, 244, 255, 0.95);
            --button-hover: rgba(224, 234, 255, 0.95);
            --available-bg: linear-gradient(135deg, #34d399, #059669);
            --available-hover: linear-gradient(135deg, #059669, #047857);
            --shadow-color: rgba(52, 211, 153, 0.2);
            --input-bg: rgba(245, 248, 255, 0.98);
            --input-border: #34d399;
            --input-shadow: rgba(52, 211, 153, 0.15);
        }
        body{font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg-gradient),var(--wave-pattern);background-blend-mode:overlay;margin:0;padding:30px;min-height:100vh;display:flex;justify-content:center;align-items:flex-start;transition:background .3s ease}
        .container{max-width:900px;width:100%;background:var(--container-bg);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);border-radius:20px;padding:30px;box-shadow:0 6px 16px rgba(0,0,0,.15);border:1px solid var(--border-color);max-height:90vh;overflow-y:auto;transition:background .3s ease,border .3s ease,transform .2s ease}
        .container:hover{transform:translateY(-5px)}
        h1{color:var(--text-color);font-size:36px;margin-bottom:30px;text-align:center;background:linear-gradient(90deg,var(--accent-color),var(--accent-dark));-webkit-background-clip:text;background-clip:text;color:transparent;font-weight:700}
        .section{margin-bottom:25px;padding:25px;background:var(--section-bg);border-radius:12px;border-left:5px solid var(--accent-color);transition:transform .2s ease,box-shadow .2s ease,background .3s ease}
        .section:hover{transform:translateY(-5px);box-shadow:0 6px 12px var(--shadow-color)}
        .section h2{color:var(--text-color);font-size:24px;margin-bottom:20px;font-weight:600}
        .teachers{display:flex;flex-wrap:wrap;gap:15px;justify-content:center}
        .teacher-btn{padding:12px 20px;background:var(--button-bg);border:1px solid var(--accent-color);border-radius:12px;cursor:pointer;font-size:16px;color:var(--text-color);font-weight:600;transition:all .3s ease,box-shadow .2s ease;white-space:normal;text-align:center;min-width:120px;margin:3px;box-shadow:0 2px 4px rgba(0,0,0,.1)}
        .teacher-btn.available{background:var(--available-bg);color:#fff;font-weight:700;border:1px solid var(--accent-dark);box-shadow:0 3px 6px rgba(0,0,0,.15)}
        .teacher-btn:hover{background:var(--button-hover);transform:scale(1.05);box-shadow:0 4px 8px var(--shadow-color);color:var(--text-color)}
        .teacher-btn.available:hover{background:var(--available-hover);color:#fff;box-shadow:0 4px 8px rgba(0,0,0,.2)}
        .search-bar{width:100%;padding:12px;margin-bottom:20px;border:1px solid var(--input-border);border-radius:10px;background:var(--input-bg);box-shadow:inset 0 2px 4px var(--input-shadow);font-size:16px;color:var(--text-color);transition:box-shadow .2s ease,border-color .2s ease}
        .search-bar:focus{outline:none;box-shadow:inset 0 2px 6px var(--input-shadow),0 0 0 3px rgba(52,211,153,.2);border-color:var(--accent-dark)}
        .form-group{margin-bottom:20px;display:flex;flex-direction:column;align-items:flex-start}
        .form-group label{display:block;font-weight:600;margin-bottom:8px;color:var(--text-color);font-size:18px}
        .form-group input,.form-group select{padding:12px;width:100%;max-width:300px;border:1px solid var(--input-border);border-radius:10px;background:var(--input-bg);box-shadow:inset 0 2px 4px var(--input-shadow);font-size:16px;color:var(--text-color);transition:box-shadow .2s ease,border-color .2s ease}
        .form-group input:focus,.form-group select:focus{outline:none;box-shadow:inset 0 2px 6px var(--input-shadow),0 0 0 3px rgba(52,211,153,.2);border-color:var(--accent-dark)}
        button{padding:14px 30px;background:var(--available-bg);color:#fff;border:none;border-radius:10px;cursor:pointer;font-size:16px;font-weight:600;transition:transform .2s ease,background .3s ease,box-shadow .2s ease;box-shadow:0 3px 6px rgba(0,0,0,.15);margin:5px}
        button:hover{transform:translateY(-3px);background:var(--available-hover);box-shadow:0 4px 8px rgba(0,0,0,.2)}
        .totals{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-bottom:20px;align-items:center}
        .totals .month-buttons{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;max-width:400px}
        .totals button{padding:10px 20px;background:var(--button-bg);color:var(--text-color);border:1px solid var(--accent-color);border-radius:12px;cursor:pointer;font-size:15px;transition:all .3s ease,box-shadow .2s ease;box-shadow:0 2px 4px rgba(0,0,0,.1);min-width:60px;flex:1 0 16%}
        .totals button:hover{background:var(--button-hover);transform:scale(1.05);box-shadow:0 4px 8px var(--shadow-color)}
        .totals button.active{background:var(--available-bg);color:#fff;box-shadow:0 3px 6px rgba(0,0,0,.15)}
        .totals select{padding:10px 15px;background:var(--button-bg);color:var(--text-color);border:1px solid var(--accent-color);border-radius:12px;font-size:15px;font-weight:600;cursor:pointer;transition:all .3s ease,box-shadow .2s ease;box-shadow:0 2px 4px rgba(0,0,0,.1);min-width:100px;appearance:none;background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="%231a202c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>');background-repeat:no-repeat;background-position:right 10px center}
        .totals select:focus{outline:none;box-shadow:0 4px 8px var(--shadow-color),0 0 0 3px rgba(52,211,153,.2);border-color:var(--accent-dark)}
        .totals select:hover{background:var(--button-hover);transform:scale(1.05)}
        .totals label{color:var(--text-color);font-size:15px;font-weight:600;margin-right:10px}
        p{font-size:16px;color:var(--text-color);margin:8px 0;text-align:center}
        .availability-list{margin-top:20px;padding:15px;background:rgba(255,255,255,.95);border-radius:10px;border-left:5px solid var(--accent-color);max-height:220px;overflow-y:auto}
        .availability-list p{margin:8px 0;font-size:16px}
        .schedule-block{margin-bottom:20px;padding:12px;background:rgba(240,250,255,0.95);border-radius:8px;border-left:4px solid var(--accent-color);font-size:15px}
        .schedule-block strong{font-weight:600;color:var(--accent-dark)}
        .export-buttons{display:flex;gap:10px;margin-top:15px;flex-wrap:wrap}
        @media (max-width:600px){
            .container{padding:20px;border-radius:15px}
            .section{padding:20px}
            .form-group input,.form-group select,.search-bar{max-width:100%}
            .teacher-btn{min-width:100px;font-size:15px}
            .totals button{padding:8px 15px;font-size:14px;min-width:50px;flex:1 0 22%}
            .totals select{min-width:90px;font-size:14px;padding:8px 12px}
            .totals label{font-size:14px;margin-right:8px}
            .totals .month-buttons{max-width:100%}
            .availability-list{max-height:180px}
            .export-buttons{justify-content:center}
        }
    </style>
</head>
<body>
<div class="container">
    <h1>IES Örebro Teacher Availability Dashboard</h1>

    <div class="section">
        <h2>Available Right Now</h2>
        <p id="availabilityTime" style="font-weight:600; color:#059669;"></p>
        <input type="text" class="search-bar" id="teacherSearch" placeholder="Search any teacher to see full weekly schedule...">
        <div class="teachers" id="availableTeachers"></div>
        <div class="availability-list" id="teacherResults"></div>
    </div>

    <div class="section">
        <h2>Support Staff</h2>
        <p id="supportTime" style="font-weight:600; color:#059669;"></p>
        <input type="text" class="search-bar" id="supportSearch" placeholder="Search any support staff to see full weekly schedule...">
        <div class="teachers" id="availableSupport"></div>
        <div class="availability-list" id="supportResults"></div>
    </div>

    <div class="section">
        <h2>Check Availability for a Time Range</h2>
        <div class="form-group"><label>Date:</label><input type="date" id="checkDate"></div>
        <div class="form-group"><label>Time (From):</label><input type="time" id="timeFrom"></div>
        <div class="form-group"><label>Time (To):</label><input type="time" id="timeTo"></div>
        <div class="form-group"><label>Time Zone:</label>
            <select id="timeZone">
                <option value="Europe/Stockholm" selected>Sweden (CET/CEST)</option>
                <option value="Europe/Paris">CET (UTC+1)</option>
                <option value="America/New_York">EST (UTC-5)</option>
                <option value="Asia/Tokyo">JST (UTC+9)</option>
                <option value="UTC">UTC</option>
            </select>
        </div>
        <button onclick="ui.handleCheckAvailability()">Check Availability</button>
        <div class="availability-list" id="availabilityResults"></div>
    </div>

    <div class="section">
        <h2>Extra Worked Minutes</h2>
        <p>This data is stored in your local browser.</p>
        <div class="form-group"><label>Teacher / Support:</label>
            <select id="extraTeacher"><option value="">-- Select --</option></select>
        </div>
        <div class="form-group"><label>Week/Year:</label><input type="text" id="weekYear" placeholder="Week 47, 2025"></div>
        <div class="form-group"><label>Minutes:</label><input type="number" id="minutes"></div>
        <button onclick="ui.handleAddEntry()">Add</button>
        <div class="export-buttons">
            <button onclick="ui.exportLocalCSV()">Export Local CSV</button>
            <button onclick="ui.exportToGoogleSheet()">Export to Google Sheet</button>
        </div>
    </div>

    <div class="section">
        <h2>Monthly Totals</h2>
        <div class="totals" id="monthTotals">
            <label for="yearSelect">Year:</label>
            <select id="yearSelect">
                <option value="2023">2023</option><option value="2024">2024</option><option value="2025" selected>2025</option>
                <option value="2026">2026</option><option value="2027">2027</option><option value="2028">2028</option>
            </select>
            <div class="month-buttons">
                <button>Jan</button><button>Feb</button><button>Mar</button><button>Apr</button>
                <button>May</button><button>Jun</button><button>Jul</button><button>Aug</button>
                <button>Sep</button><button>Oct</button><button class="active">Nov</button><button>Dec</button>
            </div>
        </div>
        <p>Total for November 2025: 0 minutes</p>
    </div>
</div>

<script>
const GOOGLE_SHEET_WEBAPP = 'https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec';

const data = {
    teachers: [],
    timeZone: 'Europe/Stockholm',

    async loadFromFile(){
        try{
            const r = await fetch('Lektioner.txt');
            if(!r.ok) throw new Error(`HTTP ${r.status}`);
            const txt = await r.text();
            const json = JSON.parse(txt);
            return Object.entries(json).map(([n,d])=>({name:n,schedule:d,role:this.roleOf(n)}));
        }catch(e){
            console.error(e);
            return this.fallbackData();
        }
    },
    roleOf(name){
        const support = ['Agnes Hellvig','Angelica Norgren','Garret Cooke','Wynonah Plattner','Vicenta Marie Linden'];
        return support.includes(name) ? 'support' : 'teacher';
    },
    fallbackData(){
        return [
            {name:"Agnes Hellvig",role:"support",schedule:{Monday:"08:00-11:35;13:10-14:10",Tuesday:"-",Wednesday:"-",Thursday:"08:15-09:15;09:25-10:25",Friday:"-"}},
            {name:"Angelica Norgren",role:"support",schedule:{Monday:"-",Tuesday:"08:15-11:25;12:30-13:55",Wednesday:"08:15-09:15;10:35-12:00;13:05-14:30",Thursday:"08:15-10:35",Friday:"08:15-11:00"}},
            {name:"Garret Cooke",role:"support",schedule:{Monday:"08:00-09:50;10:15-10:50;12:25-12:50",Tuesday:"08:00-09:15;09:50-10:30;12:40-13:30",Wednesday:"08:00-09:15;09:45-10:15;12:30-13:30",Thursday:"08:00-09:15;09:45-10:30;12:30-14:00",Friday:"08:00-09:15;09:45-10:55"}},
            {name:"Wynonah Plattner",role:"support",schedule:{Monday:"Check her schedule",Tuesday:"-",Wednesday:"-",Thursday:"-",Friday:"-"}},
            {name:"Vicenta Marie Linden",role:"support",schedule:{Monday:"12:35-14:20",Tuesday:"08:30-11:15;12:25-13:20",Wednesday:"-",Thursday:"-",Friday:"09:50-11:00;12:30-14:15"}},
            {name:"Alan Smith",role:"teacher",schedule:{Monday:"-",Tuesday:"13:35-14:50",Wednesday:"-",Thursday:"9:20-10:30",Friday:"-"}},
            {name:"Alex Reid",role:"teacher",schedule:{Monday:"-",Tuesday:"-",Wednesday:"09:00-10:00;13:20-16:00",Thursday:"10:55-12:15",Friday:"-"}},
            {name:"Alvinda Hall",role:"teacher",schedule:{Monday:"09:35-10:45;13:40-14:40",Tuesday:"12:35-14:00",Wednesday:"9:00-10:20",Thursday:"-",Friday:"-"}},
            {name:"Alyssa Gestrinius",role:"teacher",schedule:{Monday:"10:30-11:30",Tuesday:"-",Wednesday:"-",Thursday:"-",Friday:"-"}},
            {name:"Amanda Bergström",role:"teacher",schedule:{Monday:"14:45-16:00",Tuesday:"-",Wednesday:"12:50-14:30",Thursday:"-",Friday:"-"}},
            {name:"Amra Zaklan",role:"teacher",schedule:{Monday:"-",Tuesday:"10:15-11:25",Wednesday:"-",Thursday:"-",Friday:"-"}},
            {name:"Ann-Sofie Nordbrandt",role:"teacher",schedule:{Monday:"09:55-10:55",Tuesday:"13:05-15:00",Wednesday:"10:30-11:45",Thursday:"-",Friday:"-"}},
            {name:"Anna Svensson",role:"teacher",schedule:{Monday:"09:50-12:10",Tuesday:"08:00-10:55",Wednesday:"08:00-09:50",Thursday:"-",Friday:"-"}},
            {name:"Carl Ölvstam",role:"teacher",schedule:{Monday:"12:30-13:55",Tuesday:"08:00-11:00;13:30-14:30",Wednesday:"10:55-12:00",Thursday:"13:30-14:30",Friday:"-"}},
            {name:"Caroline Kohl",role:"teacher",schedule:{Monday:"12:05-13:20",Tuesday:"-",Wednesday:"-",Thursday:"10:30-11:30",Friday:"-"}},
            {name:"Catherine Asp",role:"teacher",schedule:{Monday:"08:45-10:00",Tuesday:"-",Wednesday:"-",Thursday:"11:00-12:45",Friday:"-"}},
            {name:"Dag Mollestam",role:"teacher",schedule:{Monday:"10:25-11:25;13:15-14:15",Tuesday:"-",Wednesday:"-;13:15-14:30",Thursday:"-",Friday:"8:00-9:20"}},
            {name:"Dane Söderkvist",role:"teacher",schedule:{Monday:"08:00-09:10",Tuesday:"13:25-14:25",Wednesday:"-",Thursday:"-",Friday:"09:20-10:30"}},
            {name:"Elyssa Fors",role:"teacher",schedule:{Monday:"8:45-10:05;13:55-15:00",Tuesday:"13:40-15:00",Wednesday:"-",Thursday:"11:35-12:50;13:50-15:30",Friday:"-"}},
            {name:"Fiona Olsson",role:"teacher",schedule:{Monday:"09:20-10:20",Tuesday:"13:30-16:00",Wednesday:"09:20-10:30;13:15-23:59",Thursday:"09:25-11:20",Friday:"-"}},
            {name:"Hanna Ohlsson",role:"teacher",schedule:{Monday:"09:20-11:00;14:25-15:30",Tuesday:"09:15-11:00",Wednesday:"-",Thursday:"13:20-14:30",Friday:"09:20-10:30"}},
            {name:"Jessica Erke",role:"teacher",schedule:{Monday:"08:00-09:50;11:00-12:05",Tuesday:"08:10-10:25",Wednesday:"10:20-11:35",Thursday:"-",Friday:"08:00-09:20"}},
            {name:"Jo-Anne Wong",role:"teacher",schedule:{Monday:"-",Tuesday:"-",Wednesday:"-;12:50-16:00",Thursday:"-",Friday:"09:20-10:40"}},
            {name:"Johan Anselmius",role:"teacher",schedule:{Monday:"09:50-11:00",Tuesday:"15:00-16:00",Wednesday:"09:20-10:25",Thursday:"-",Friday:"-"}},
            {name:"Jon Hammar",role:"teacher",schedule:{Monday:"-",Tuesday:"08:15-09:15",Wednesday:"09:00-11:05",Thursday:"08:15-09:30",Friday:"08:00-09:15"}},
            {name:"Juan Ruiz",role:"teacher",schedule:{Monday:"Check his schedule, doesn't work everyday",Tuesday:"12:50-14:35",Wednesday:"-",Thursday:"12:30-13:35",Friday:"-"}},
            {name:"Kayley Scrooby",role:"teacher",schedule:{Monday:"12:45-14:20",Tuesday:"-",Wednesday:"-",Thursday:"09:50-11:05",Friday:"-"}},
            {name:"Kevin Belyea",role:"teacher",schedule:{Monday:"14:50-16:00",Tuesday:"-",Wednesday:"9:20-11:40",Thursday:"12:00-13:40",Friday:"-"}},
            {name:"Kristoffer Sjöberg",role:"teacher",schedule:{Monday:"08:45-10:05;13:05-14:05",Tuesday:"12:10-13:45",Wednesday:"11:15-12:35",Thursday:"09:40-10:50;-",Friday:"08:00-09:40"}},
            {name:"Lethea McCann",role:"teacher",schedule:{Monday:"-",Tuesday:"09:20-11:25;12:40-14:50",Wednesday:"-",Thursday:"13:05-14:40",Friday:"09:15-10:25"}},
            {name:"Linda Nordh",role:"teacher",schedule:{Monday:"-",Tuesday:"-",Wednesday:"-",Thursday:"-",Friday:"-"}},
            {name:"Linda Palmkvist",role:"teacher",schedule:{Monday:"08:50-09:50",Tuesday:"-",Wednesday:"-",Thursday:"12:50-13:55",Friday:"-"}},
            {name:"Lisa Lonergan",role:"teacher",schedule:{Monday:"12:40-14:35",Tuesday:"09:20-10:35",Wednesday:"09:35-10:55",Thursday:"09:20-11:15;12:00-14:45",Friday:"11:20-14:00"}},
            {name:"Michaela Japec",role:"teacher",schedule:{Monday:"-",Tuesday:"-",Wednesday:"09:15-11:45",Thursday:"10:30-11:45",Friday:"08:00-09:45"}},
            {name:"Naomi Kirkvold",role:"teacher",schedule:{Monday:"09:20-10:30;13:35-14:40",Tuesday:"-",Wednesday:"09:20-10:40",Thursday:"12:15-13:25",Friday:"09:15-10:25"}},
            {name:"Niclas Andersson",role:"teacher",schedule:{Monday:"-",Tuesday:"13:40-14:30",Wednesday:"09:00-10:20",Thursday:"-",Friday:"14:00-15:50"}},
            {name:"Nina Easy Palm",role:"teacher",schedule:{Monday:"-",Tuesday:"12:25-13:25",Wednesday:"12:40-13:40",Thursday:"-",Friday:"-"}},
            {name:"Patricio Caro Gonzalez",role:"teacher",schedule:{Monday:"-",Tuesday:"-",Wednesday:"-",Thursday:"-",Friday:"10:50-11:50"}},
            {name:"Susanne Lundkvist",role:"teacher",schedule:{Monday:"09:25-10:30",Tuesday:"12:30-14:35",Wednesday:"-",Thursday:"-",Friday:"09:20-10:30;12:05-13:30"}},
            {name:"Tekla Alsbjer",role:"teacher",schedule:{Monday:"14:10-15:15",Tuesday:"09:20-10:25",Wednesday:"08:00-09:15",Thursday:"14:40-15:45",Friday:"09:15-10:30"}},
            {name:"Tilde Lidner",role:"teacher",schedule:{Monday:"09:50-11:05;12:20-13:30",Tuesday:"-",Wednesday:"09:20-10:25;12:00-13:35",Thursday:"11:55-13:30",Friday:"-"}},
            {name:"Timothy Parcel",role:"teacher",schedule:{Monday:"13:15-14:45",Tuesday:"-",Wednesday:"13:15-16:00",Thursday:"-",Friday:"08:00-09:45"}},
            {name:"Yoni Olsson",role:"teacher",schedule:{Monday:"12:20-14:00",Tuesday:"09:15-10:20;14:50-16:00",Wednesday:"-",Thursday:"08:00-09:15;13:00-14:30",Friday:"-"}},
            {name:"Zlatan Jaranovic",role:"teacher",schedule:{Monday:"10:55-12:00",Tuesday:"08:00-09:15",Wednesday:"08:00-09:30",Thursday:"-",Friday:"-"}},
            {name:"Zofia Czarnowska",role:"teacher",schedule:{Monday:"-",Tuesday:"14:45-16:00",Wednesday:"11:20-12:30",Thursday:"11:20-12:35;14:30-16:00",Friday:"9:20-10:30"}}
        ];
    },
    getWeeklySchedule(person){
        const days = ['Monday','Tuesday','Wednesday','Thursday','Friday'];
        const out = {};
        days.forEach(d => {
            const raw = person.schedule[d] || '-';
            if (raw.includes('Check') || raw.includes('any')) out[d] = 'Check schedule';
            else out[d] = raw === '-' ? '-' : raw.split(';').filter(r => r !== '-').join(', ');
        });
        return out;
    }
};

const ui = {
    init(){
        this.updateTimes();
        setInterval(() => this.updateTimes(), 30000);
        data.loadFromFile().then(list => {
            data.teachers = list;
            this.renderAvailableNow();
            this.fillDropdown();
            this.setupSearchBars();
            this.setupTimeZone();
        });
    },

    updateTimes(){
        const now = new Date();
        const swedishTime = now.toLocaleTimeString('sv-SE', {timeZone:'Europe/Stockholm', hour:'2-digit', minute:'2-digit'});
        const localTime = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        const weekNum = this.getWeekNumber(now);
        const monthName = now.toLocaleString('en-US', {month:'long', timeZone:'Europe/Stockholm'});
        const year = now.getFullYear();
        const localPart = localTime !== swedishTime ? ` (your local: ${localTime})` : '';
        const str = `Available as of ${swedishTime} Swedish time${localPart} · Week ${year}-W${String(weekNum).padStart(2,'0')} · ${monthName} ${year}`;
        document.getElementById('availabilityTime').textContent = str;
        document.getElementById('supportTime').textContent = str;
    },

    getWeekNumber(d) {
        const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        date.setUTCDate(date.getUTCDate() + 4 - (date.getUTCDay() || 7));
        const yearStart = new Date(Date.UTC(d.getFullYear(), 0, 1));
        return Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
    },

    renderAvailableNow(){
        this.renderSection('teacher');
        this.renderSection('support');
    },
    renderSection(role){
        const container = document.getElementById(role === 'teacher' ? 'availableTeachers' : 'availableSupport');
        container.innerHTML = '';
        const now = new Date();
        const curMin = this.getCurrentMinutes(now);
        const available = data.teachers.filter(p => p.role === role && this.isAvailableNow(p, now, curMin));
        available.forEach(p => {
            const btn = document.createElement('button');
            btn.className = 'teacher-btn available';
            btn.textContent = p.name;
            btn.onclick = () => this.showFullSchedule(p.name, role === 'teacher' ? 'teacherResults' : 'supportResults');
            container.appendChild(btn);
        });
        if (!available.length) container.innerHTML = `<p>No ${role}s available right now.</p>`;
    },
    isAvailableNow(person, date, curMin){
        const day = date.toLocaleString('en-US', {weekday:'long', timeZone:'Europe/Stockholm'});
        const sched = person.schedule[day] || "-";
        if (sched.includes('Check') || sched === '-' || sched.includes('any')) return false;
        return sched.split(';').some(r => {
            if (r === '-' || !r) return false;
            let [s, e] = r.split('-');
            if (!e) e = '23:59';
            [s, e] = [s.padStart(5,'0'), e.padStart(5,'0')];
            const sm = (+s.split(':')[0])*60 + +s.split(':')[1];
            const em = (+e.split(':')[0])*60 + +e.split(':')[1];
            return sm <= curMin && em >= curMin;
        });
    },
    getCurrentMinutes(date){
        const [h,m] = date.toLocaleString('en-US',{hour:'2-digit',minute:'2-digit',hour12:false,timeZone:'Europe/Stockholm'}).split(':').map(Number);
        return h*60 + m;
    },
    fillDropdown(){
        const sel = document.getElementById('extraTeacher');
        sel.innerHTML = '<option value="">-- Select --</option>';
        data.teachers.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.name; opt.textContent = p.name; sel.appendChild(opt);
        });
    },
    setupSearchBars(){
        const teacherInput = document.getElementById('teacherSearch');
        const supportInput = document.getElementById('supportSearch');
        teacherInput.addEventListener('input', () => this.handleSearch('teacher'));
        supportInput.addEventListener('input', () => this.handleSearch('support'));
        teacherInput.addEventListener('focus', () => document.getElementById('teacherResults').innerHTML = '');
        supportInput.addEventListener('focus', () => document.getElementById('supportResults').innerHTML = '');
    },
    handleSearch(role){
        const input = document.getElementById(role === 'teacher' ? 'teacherSearch' : 'supportSearch');
        const term = input.value.trim().toLowerCase();
        const resultsDiv = document.getElementById(role === 'teacher' ? 'teacherResults' : 'supportResults');
        resultsDiv.innerHTML = '';
        if (!term) { this.renderAvailableNow(); return; }
        const matches = data.teachers.filter(p => p.role === role && p.name.toLowerCase().includes(term));
        if (matches.length === 0) {
            resultsDiv.innerHTML = '<p>No one found.</p>';
            return;
        }
        matches.forEach(person => {
            const block = document.createElement('div');
            block.className = 'schedule-block';
            block.innerHTML = `<strong>${person.name}'s Weekly Schedule</strong><br>`;
            const week = data.getWeeklySchedule(person);
            ['Monday','Tuesday','Wednesday','Thursday','Friday'].forEach(day => {
                block.innerHTML += `<div><strong>${day}:</strong> ${week[day] || '-'}</div>`;
            });
            resultsDiv.appendChild(block);
        });
    },
    showFullSchedule(name, targetId){
        const div = document.getElementById(targetId);
        div.innerHTML = '';
        const person = data.teachers.find(p => p.name === name);
        if (!person) return;
        const block = document.createElement('div');
        block.className = 'schedule-block';
        block.innerHTML = `<strong>${name}'s Weekly Schedule</strong><br>`;
        const week = data.getWeeklySchedule(person);
        ['Monday','Tuesday','Wednesday','Thursday','Friday'].forEach(day => {
            block.innerHTML += `<div><strong>${day}:</strong> ${week[day] || '-'}</div>`;
        });
        div.appendChild(block);
    },

    // ← FIXED: "Check Availability" now correctly finds ALL teachers again
    handleCheckAvailability(){
        const date = document.getElementById('checkDate').value;
        const from = document.getElementById('timeFrom').value;
        const to = document.getElementById('timeTo').value;
        const out = document.getElementById('availabilityResults');
        if (!date || !from || !to) {
            out.innerHTML = '<p style="color:#b91c1c;">Please fill all fields.</p>';
            return;
        }
        const [fh, fm] = from.split(':').map(Number);
        const [th, tm] = to.split(':').map(Number);
        const fromMin = fh*60 + fm;
        const toMin = th*60 + tm;
        const checkDate = new Date(`${date}T${from}:00`);
        out.innerHTML = '';
        const matches = data.teachers.filter(p => this.isAvailableInRange(p, checkDate, fromMin, toMin));
        if (matches.length === 0) {
            out.innerHTML = '<p>No one available in that time range.</p>';
            return;
        }
        matches.forEach(p => {
            const day = checkDate.toLocaleString('en-US', {weekday:'long', timeZone:'Europe/Stockholm'}); // ← Always Swedish day
            const sched = p.schedule[day] || '-';
            const overlapping = this.getOverlappingTimes(sched, fromMin, toMin);
            if (overlapping.length === 0) return;
            const pEl = document.createElement('p');
            pEl.textContent = `${p.name}: ${overlapping.join(', ')}`;
            out.appendChild(pEl);
        });
    },
    isAvailableInRange(person, date, fromMin, toMin){
        const day = date.toLocaleString('en-US', {weekday:'long', timeZone:'Europe/Stockholm'});
        const sched = person.schedule[day] || '-';
        if (sched.includes('Check') || sched === '-' || sched.includes('any')) return false;
        return sched.split(';').some(r => {
            if (r === '-' || !r) return false;
            let [s, e] = r.split('-');
            if (!e) e = '23:59';
            [s, e] = [s.padStart(5,'0'), e.padStart(5,'0')];
            const sm = (+s.split(':')[0])*60 + +s.split(':')[1];
            const em = (+e.split(':')[0])*60 + +e.split(':')[1];
            return sm <= toMin && em >= fromMin;
        });
    },
    getOverlappingTimes(sched, fromMin, toMin){
        return (sched || '').split(';').filter(r => {
            if (r === '-' || !r) return false;
            let [s, e] = r.split('-');
            if (!e) e = '23:59';
            [s, e] = [s.padStart(5,'0'), e.padStart(5,'0')];
            const sm = (+s.split(':')[0])*60 + +s.split(':')[1];
            const em = (+e.split(':')[0])*60 + +e.split(':')[1];
            return sm <= toMin && em >= fromMin;
        }).map(r => r.split('-').map(t => t.padStart(5,'0')).join('-'));
    },

    handleAddEntry(){
        const who = document.getElementById('extraTeacher').value;
        const week = document.getElementById('weekYear').value;
        const mins = document.getElementById('minutes').value;
        if (!who || !week || !mins) { alert('Fill all fields'); return; }
        const store = JSON.parse(localStorage.getItem('extraMins') || '[]');
        store.push({who, week, mins: +mins});
        localStorage.setItem('extraMins', JSON.stringify(store));
        alert('Added');
        document.getElementById('extraTeacher').value = '';
        document.getElementById('weekYear').value = '';
        document.getElementById('minutes').value = '';
    },
    setupTimeZone(){
        document.getElementById('timeZone').addEventListener('change', e => {
            data.timeZone = e.target.value;
            ui.updateTimes();
            ui.renderAvailableNow();
        });
    },
    exportLocalCSV() {
        const raw = JSON.parse(localStorage.getItem('extraMins') || '[]');
        if (!raw.length) { alert('No data to export'); return; }
        let csv = 'Teacher/Staff,Week,Minutes\n';
        raw.forEach(r => csv += `"${r.who}","${r.week}",${r.mins}\n`);
        const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `extra_minutes_${new Date().toISOString().slice(0,10)}.csv`;
        a.click(); URL.revokeObjectURL(url);
    },
    async exportToGoogleSheet() {
        const raw = JSON.parse(localStorage.getItem('extraMins') || '[]');
        if (!raw.length) { alert('No data to export'); return; }
        const payload = raw.map(r => [r.who, r.week, r.mins]);
        try {
            await fetch(GOOGLE_SHEET_WEBAPP, {method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
            alert('Data successfully sent to Google Sheet!');
        } catch (e) { console.error(e); alert('Error sending data – check console'); }
    }
};

document.addEventListener('DOMContentLoaded', () => ui.init());
</script>
</body>
</html>
